<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>EatSure â€“ MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body style="font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;">

  <h1>EatSure</h1>

  <p>Barkod numarasÄ±nÄ± gir veya kamerayla tara:</p>

  <input
    type="text"
    id="barcodeInput"
    placeholder="Ã–rn: 8008698004845"
    style="font-size:16px; padding:8px; width:100%; max-width:320px;"
  />

  <br><br>

  <button onclick="scanProduct('manual')" style="font-size:16px; padding:10px 16px;">
    Sorgula
  </button>

  <button onclick="startCameraScan()" style="font-size:16px; padding:10px 16px; margin-left:8px;">
    ğŸ“· Kamera ile tara
  </button>

  <div id="reader" style="width:100%; max-width:320px; margin-top:16px;"></div>

  <div id="productInfo" style="margin-top:20px; font-weight:600;"></div>
  <div id="result" style="margin-top:10px; padding:14px; border-radius:8px;"></div>
  <div id="scopeNote" style="margin-top:8px; font-size:14px; color:#555;"></div>
  <div id="actions" style="margin-top:16px;"></div>

  <script>
    let html5QrCode;
    let dotsInterval = null;
    let slowNoticeTimeout = null;

    const CERTIFIER_LABELS = {
      GFCO: "GFCO (Gluten-Free Certification Organization)"
    };

    function isValidEAN13(code) {
      if (!/^\d{13}$/.test(code)) return false;
      const digits = code.split("").map(Number);
      const checksum = digits.pop();
      const sum = digits.reduce((acc, digit, index) => {
        return acc + digit * (index % 2 === 0 ? 1 : 3);
      }, 0);
      const calculated = (10 - (sum % 10)) % 10;
      return checksum === calculated;
    }

    function startDots() {
      let dots = 0;
      stopDots();
      dotsInterval = setInterval(() => {
        dots = (dots + 1) % 4;
        const el = document.getElementById("loadingDots");
        if (el) el.textContent = ".".repeat(dots);
      }, 500);
    }

    function stopDots() {
      if (dotsInterval) {
        clearInterval(dotsInterval);
        dotsInterval = null;
      }
    }

    function resetForNextScan() {
      stopDots();
      clearTimeout(slowNoticeTimeout);
      barcodeInput.value = "";
      productInfo.innerHTML = "";
      result.innerHTML = "";
      scopeNote.innerHTML = "";
      result.style.background = "transparent";
      actions.innerHTML = "";
      reader.innerHTML = "";
      barcodeInput.focus();
      if (html5QrCode) html5QrCode.stop().catch(() => {});
    }

    function startCameraScan() {
      reader.innerHTML = "";
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        text => {
          barcodeInput.value = text;
          html5QrCode.stop().catch(() => {});
          scanProduct("camera");
        }
      );
    }

    async function scanProduct(source) {
      const barcode = barcodeInput.value.trim();
      productInfo.innerHTML = "";
      scopeNote.innerHTML = "";
      actions.innerHTML = "";
      clearTimeout(slowNoticeTimeout);

      if (!barcode) {
        result.style.background = "#eee";
        result.innerHTML = "<p>LÃ¼tfen barkod gir.</p>";
        return;
      }

      if (!isValidEAN13(barcode)) {
        result.style.background = "#fff4d6";
        result.innerHTML = source === "camera"
          ? "<h2>âš ï¸ Barkod net okunamadÄ±</h2><p>IÅŸÄ±ÄŸÄ± ayarlayÄ±p tekrar deneyin.</p>"
          : "<h2>âš ï¸ Girilen barkod geÃ§erli gÃ¶rÃ¼nmÃ¼yor</h2><p>NumarayÄ± kontrol edin.</p>";
        return;
      }

      result.style.background = "#f5f5f5";
      result.innerHTML = `
        <p>ğŸ” Barkod doÄŸrulandÄ±. ÃœrÃ¼n aranÄ±yor<span id="loadingDots"></span></p>
      `;
      startDots();

      slowNoticeTimeout = setTimeout(() => {
        result.innerHTML = `
          <p>ğŸ” Barkod doÄŸrulandÄ±. ÃœrÃ¼n aranÄ±yor<span id="loadingDots"></span></p>
          <p style="font-size:14px;color:#777;">
            â³ Bu iÅŸlem normalden uzun sÃ¼rÃ¼yor, lÃ¼tfen bekleyinâ€¦
          </p>
        `;
      }, 8000);

      try {
        const res = await fetch(
          "https://eatsure-backend-4dkh.onrender.com/scan/" + barcode
        );

        stopDots();
        clearTimeout(slowNoticeTimeout);

        if (!res.ok) {
          result.style.background = "#eee";
          result.innerHTML = `
            <h2>âš ï¸ Sunucu geÃ§ici olarak yanÄ±t veremiyor</h2>
            <p>LÃ¼tfen birkaÃ§ saniye sonra tekrar deneyin.</p>
          `;
          actions.innerHTML = `<button onclick="resetForNextScan()">Yeni Ã¼rÃ¼n tara</button>`;
          return;
        }

        const data = await res.json();

        if (data.brand || data.name) {
          productInfo.innerHTML = `${data.brand || ""} ${data.name || ""}`;
        }

        const d = data.decision;
        if (!d) throw new Error("decision_missing");

        let title="", subtitle="", bg="#eee", scope="";

        if (d.status === "safe" && d.level === "certified") {
          title = "âœ… Ã‡Ã¶lyak iÃ§in uygundur";
          bg = "#e7f6ea";
          const labels = (d.sources || []).map(id => CERTIFIER_LABELS[id] || id);
          subtitle = labels.length
            ? `${labels.join(" ve ")} tarafÄ±ndan sertifikalandÄ±rÄ±lmÄ±ÅŸtÄ±r.`
            : "BaÄŸÄ±msÄ±z sertifikasyon mevcuttur.";
          scope = "DeÄŸerlendirme marka bazlÄ± sertifikasyon bilgilerine dayanmaktadÄ±r.";
        }
        else if (d.status === "declared_gluten_free") {
          title = "âš ï¸ Ãœretici beyanÄ±na gÃ¶re glutensiz";
          subtitle = d.reason || "";
          bg = "#fff4d6";
          scope = "Bilgi Ã¼retici beyanÄ±na dayanmaktadÄ±r.";
        }
        else if (d.status === "unsafe") {
          title = "âŒ Ã‡Ã¶lyak iÃ§in uygun deÄŸildir";
          subtitle = d.reason || "";
          bg = "#fdecea";
          scope = "DeÄŸerlendirme iÃ§erik analizine dayanmaktadÄ±r.";
        }
        else {
          title = "â“ Bilgi yetersiz";
          subtitle = d.reason || "";
          bg = "#f0f0f0";
        }

        result.style.background = bg;
        result.innerHTML = `<h2>${title}</h2><p>${subtitle}</p>`;
        scopeNote.innerHTML = scope;
        actions.innerHTML = `<button onclick="resetForNextScan()">Yeni Ã¼rÃ¼n tara</button>`;

      } catch (err) {
        stopDots();
        clearTimeout(slowNoticeTimeout);
        result.style.background = "#eee";
        result.innerHTML = `
          <h2>âš ï¸ BaÄŸlantÄ± hatasÄ±</h2>
          <p>Ä°nternet baÄŸlantÄ±sÄ± veya sunucuya eriÅŸimde sorun oluÅŸtu.</p>
        `;
        actions.innerHTML = `<button onclick="resetForNextScan()">Yeni Ã¼rÃ¼n tara</button>`;
      }
    }
  </script>

</body>
</html>
