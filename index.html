<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>EatSure â€“ MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body style="font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;">

  <h1>EatSure</h1>

  <p>Barkod numarasÄ±nÄ± gir veya kamerayla tara:</p>

  <input
    type="text"
    id="barcodeInput"
    placeholder="Ã–rn: 8008698004845"
    style="font-size:16px; padding:8px; width:100%; max-width:320px;"
  />

  <br><br>

  <button onclick="scanProduct('manual')" style="font-size:16px; padding:10px 16px;">
    Sorgula
  </button>

  <button onclick="startCameraScan()" style="font-size:16px; padding:10px 16px; margin-left:8px;">
    ğŸ“· Kamera ile tara
  </button>

  <div id="reader" style="width:100%; max-width:320px; margin-top:16px;"></div>

  <div id="result" style="margin-top:20px; padding:14px; border-radius:8px;"></div>
  <div id="scopeNote" style="margin-top:8px; font-size:14px; color:#555;"></div>
  <div id="actions" style="margin-top:16px;"></div>

  <script>
    let html5QrCode;

    // -------------------------
    // EAN-13 CHECKSUM
    // -------------------------
    function isValidEAN13(code) {
      if (!/^\d{13}$/.test(code)) return false;

      const digits = code.split("").map(Number);
      const checksum = digits.pop();

      const sum = digits.reduce((acc, digit, index) => {
        return acc + digit * (index % 2 === 0 ? 1 : 3);
      }, 0);

      const calculated = (10 - (sum % 10)) % 10;
      return checksum === calculated;
    }

    function resetForNextScan() {
      document.getElementById("barcodeInput").value = "";
      document.getElementById("result").innerHTML = "";
      document.getElementById("scopeNote").innerHTML = "";
      document.getElementById("result").style.background = "transparent";
      document.getElementById("actions").innerHTML = "";
      document.getElementById("reader").innerHTML = "";
      document.getElementById("barcodeInput").focus();

      if (html5QrCode) {
        html5QrCode.stop().catch(() => {});
      }
    }

    function startCameraScan() {
      document.getElementById("reader").innerHTML = "";
      html5QrCode = new Html5Qrcode("reader");

      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          document.getElementById("barcodeInput").value = decodedText;
          html5QrCode.stop().catch(() => {});
          scanProduct("camera");
        },
        () => {}
      ).catch(err => {
        alert("Kamera aÃ§Ä±lamadÄ±: " + err);
      });
    }

    async function scanProduct(source) {
      const barcode = document.getElementById("barcodeInput").value.trim();
      const resultBox = document.getElementById("result");
      const scopeBox = document.getElementById("scopeNote");
      const actionsBox = document.getElementById("actions");

      actionsBox.innerHTML = "";
      scopeBox.innerHTML = "";

      if (!barcode) {
        resultBox.style.background = "#eee";
        resultBox.innerHTML = "<p>LÃ¼tfen barkod gir.</p>";
        return;
      }

      if (!isValidEAN13(barcode)) {
        resultBox.style.background = "#fff4d6";

        if (source === "camera") {
          resultBox.innerHTML = `
            <h2>âš ï¸ Barkod net okunamadÄ±</h2>
            <p>LÃ¼tfen Ä±ÅŸÄ±ÄŸÄ± ayarlayÄ±p tekrar deneyin veya barkodu elle girin.</p>
          `;
        } else {
          resultBox.innerHTML = `
            <h2>âš ï¸ Girilen barkod geÃ§erli gÃ¶rÃ¼nmÃ¼yor</h2>
            <p>LÃ¼tfen barkod numarasÄ±nÄ± kontrol edin.</p>
          `;
        }
        return;
      }

      resultBox.style.background = "#f5f5f5";
      resultBox.innerHTML = "<p>ÃœrÃ¼n bilgileri kontrol ediliyorâ€¦</p>";

      try {
        const response = await fetch(
          "https://eatsure-backend-4dkh.onrender.com/scan/" + barcode
        );
        const data = await response.json();
        const decision = data.decision;

        if (!decision) {
          resultBox.style.background = "#eee";
          resultBox.innerHTML = "<p>Karar bilgisi alÄ±namadÄ±.</p>";
          return;
        }

        let title = "";
        let subtitle = "";
        let scopeText = "";
        let bg = "#eee";

        if (decision.status === "safe" && decision.level === "certified") {
          title = "âœ… Ã‡Ã¶lyak iÃ§in uygundur";
          subtitle = "BaÄŸÄ±msÄ±z sertifikasyon programlarÄ±nda yer almaktadÄ±r.";
          scopeText = "Bu deÄŸerlendirme, markaya ait sertifikasyon bilgilerine dayanmaktadÄ±r.";
          bg = "#e7f6ea";
        } 
        else if (decision.status === "declared_gluten_free") {
          title = "âš ï¸ Ãœretici beyanÄ±na gÃ¶re glutensiz";
          subtitle = "Taranan sertifikasyon kaynaklarÄ±nda doÄŸrulanmÄ±ÅŸ bir sertifika bulunamadÄ±.";
          scopeText = "Bu bilgi Ã¼retici beyanÄ±na dayanmaktadÄ±r.";
          bg = "#fff4d6";
        } 
        else if (decision.status === "unsafe") {
          title = "âŒ Ã‡Ã¶lyak iÃ§in uygun deÄŸildir";
          subtitle = decision.reason || "Gluten riski tespit edildi.";
          scopeText = "Bu deÄŸerlendirme Ã¼rÃ¼n iÃ§eriÄŸi ve uyarÄ±lara dayanmaktadÄ±r.";
          bg = "#fdecea";
        } 
        else {
          title = "â“ Bilgi yetersiz";
          subtitle = decision.reason || "Yeterli veri bulunamadÄ±.";
          scopeText = "Bu Ã¼rÃ¼n iÃ§in yeterli doÄŸrulanabilir bilgiye ulaÅŸÄ±lamadÄ±.";
          bg = "#f0f0f0";
        }

        resultBox.style.background = bg;
        resultBox.innerHTML = `
          <h2 style="margin-top:0;">${title}</h2>
          <p>${subtitle}</p>
        `;
        scopeBox.innerHTML = scopeText;

        actionsBox.innerHTML = `
          <button onclick="resetForNextScan()" style="font-size:16px; padding:10px 16px;">
            Yeni Ã¼rÃ¼n tara
          </button>
        `;

      } catch (error) {
        resultBox.style.background = "#eee";
        resultBox.innerHTML = "<p>Bir hata oluÅŸtu.</p>";
      }
    }
  </script>

</body>
</html>
