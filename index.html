<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>EatSure â€“ MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body style="font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;">

  <h1>EatSure</h1>

  <p>Barkod numarasÄ±nÄ± gir veya kamerayla tara:</p>

  <input
    type="text"
    id="barcodeInput"
    placeholder="Ã–rn: 8008698004845"
    style="font-size:16px; padding:8px; width:100%; max-width:320px;"
  />

  <br><br>

  <button onclick="scanProduct('manual')" style="font-size:16px; padding:10px 16px;">
    Sorgula
  </button>

  <button onclick="startCameraScan()" style="font-size:16px; padding:10px 16px; margin-left:8px;">
    ðŸ“· Kamera ile tara
  </button>

  <div id="reader" style="width:100%; max-width:320px; margin-top:16px;"></div>

  <div id="productInfo" style="margin-top:20px; font-weight:600;"></div>
  <div id="result" style="margin-top:10px; padding:14px; border-radius:8px;"></div>
  <div id="scopeNote" style="margin-top:8px; font-size:14px; color:#555;"></div>
  <div id="evaluatedAtNote" style="margin-top:8px; font-size:13px; color:#777;"></div>
  <div id="actions" style="margin-top:16px;"></div>

  <script>
    let html5QrCode;
    let dotsInterval = null;

    const LEVEL_UI = {
      certified: {
        title: "âœ… Ã‡Ã¶lyak iÃ§in uygundur",
        color: "#2ecc71",
        scope: "DeÄŸerlendirme geÃ§erli glutensiz sertifikalara dayanmaktadÄ±r."
      },
      declared_gluten_free_with_ingredients: {
        title: "ðŸŸ¢ Glutensiz (beyan + iÃ§erik)",
        color: "#7bed9f",
        scope: "Ãœretici beyanÄ± ve iÃ§erik bilgisine dayanmaktadÄ±r."
      },
      declared_gluten_free: {
        title: "ðŸŸ¡ Ãœretici beyanÄ±na gÃ¶re glutensiz",
        color: "#f1c40f",
        scope: "Bilgi yalnÄ±zca Ã¼retici beyanÄ±na dayanmaktadÄ±r."
      },
      ingredients_safe_no_claim: {
        title: "ðŸŸ¨ Ä°Ã§erik uygun, garanti yok",
        color: "#f9e79f",
        scope: "Ä°Ã§erik gluten iÃ§ermemektedir ancak beyan veya sertifika yoktur."
      },
      declaration_conflict: {
        title: "ðŸŸ  Ã‡eliÅŸkili bilgi",
        color: "#f39c12",
        scope: "Ãœretici beyanÄ± ile iÃ§erik bilgisi Ã§eliÅŸmektedir."
      },
      gluten_present: {
        title: "ðŸ”´ Ã‡Ã¶lyak iÃ§in uygun deÄŸildir",
        color: "#e74c3c",
        scope: "Ä°Ã§erikte gluten veya gluten kaynaÄŸÄ± bulunmaktadÄ±r."
      },
      insufficient_data: {
        title: "âšª Bilgi yetersiz",
        color: "#ecf0f1",
        scope: "Yeterli veri bulunmamaktadÄ±r."
      }
    };

    function formatDate(iso) {
      const d = new Date(iso);
      return `${String(d.getDate()).padStart(2,"0")}.${String(d.getMonth()+1).padStart(2,"0")}.${d.getFullYear()}`;
    }

    function startCameraScan() {
      reader.innerHTML = "";
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        text => {
          barcodeInput.value = text;
          html5QrCode.stop();
          scanProduct();
        }
      );
    }

    async function scanProduct() {
      const barcode = barcodeInput.value.trim();
      productInfo.innerHTML = "";
      scopeNote.innerHTML = "";
      evaluatedAtNote.innerHTML = "";
      actions.innerHTML = "";

      if (!barcode) {
        result.innerHTML = "Barkod giriniz.";
        return;
      }

      result.innerHTML = "ðŸ”Ž ÃœrÃ¼n aranÄ±yorâ€¦";

      let data;
      try {
        const res = await fetch("https://eatsure-backend-4dkh.onrender.com/scan/" + barcode);
        data = await res.json();
      } catch {
        result.innerHTML = "Sunucuya ulaÅŸÄ±lamÄ±yor.";
        return;
      }

      if (data.brand || data.name) {
        productInfo.innerHTML = `${data.brand || ""} ${data.name || ""}`;
      }

      const level = data.decision?.level || "insufficient_data";
      const ui = LEVEL_UI[level] || LEVEL_UI.insufficient_data;

      result.style.background = ui.color;
      result.innerHTML = `<h2>${ui.title}</h2><p>${data.decision?.reason || ""}</p>`;
      scopeNote.innerHTML = ui.scope;

      if (data.meta?.evaluatedAt) {
        evaluatedAtNote.innerHTML =
          `Bu deÄŸerlendirme, <strong>${formatDate(data.meta.evaluatedAt)}</strong> tarihinde mevcut olan verilere gÃ¶re oluÅŸturulmuÅŸtur.`;
      }

      actions.innerHTML = `<button onclick="location.reload()">Yeni Ã¼rÃ¼n tara</button>`;
    }
  </script>

</body>
</html>
